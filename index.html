<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Agenda de Estudiantes</title>

    <!-- Tailwind via CDN (r√°pido para GitHub Pages) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Manifest + SW se inyectan por JS para que funcione con 1 solo archivo -->
  </head>
  <body class="min-h-dvh bg-slate-50 text-slate-900">
    <div id="root"></div>

    <!-- React 18 + ReactDOM + Babel para correr JSX sin build -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      // ===== Manifest y Service Worker "en caliente" (1 solo archivo) =====
      (function initPWA() {
        const manifest = {
          name: "Agenda de Estudiantes",
          short_name: "Agenda",
          description: "Tomar lista (offline): Presente/Ausente/Revisar.",
          start_url: ".",
          scope: ".",
          display: "standalone",
          background_color: "#0f172a",
          theme_color: "#0ea5e9",
          icons: [
            { src: "data:image/png;base64,iVBORw0KGgo=", sizes: "192x192", type: "image/png" },
            { src: "data:image/png;base64,iVBORw0KGgo=", sizes: "512x512", type: "image/png" }
          ],
        };
        const blob = new Blob([JSON.stringify(manifest)], { type: "application/json" });
        const manifestURL = URL.createObjectURL(blob);
        let link = document.querySelector('link[rel="manifest"]');
        if (!link) { link = document.createElement('link'); link.rel = 'manifest'; document.head.appendChild(link); }
        link.href = manifestURL;

        // Service Worker minimalista (cache first, luego red)
        const swCode = `
          const CACHE = 'agenda-cache-v1';
          self.addEventListener('install', e => {
            e.waitUntil((async()=>{ const c = await caches.open(CACHE); await c.addAll(['./']); self.skipWaiting(); })());
          });
          self.addEventListener('activate', e => { e.waitUntil(self.clients.claim()); });
          self.addEventListener('fetch', e => {
            e.respondWith((async()=>{
              const r = await caches.match(e.request); if (r) return r;
              try { const f = await fetch(e.request); const c = await caches.open(CACHE); c.put(e.request, f.clone()); return f; } catch(err){ return r || Response.error(); }
            })());
          });`;
        const swBlob = new Blob([swCode], { type: 'text/javascript' });
        const swURL = URL.createObjectURL(swBlob);
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register(swURL).catch(()=>{}); }
      })();
    </script>

    <!-- ===== La App ===== -->
    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;
      const LS_KEY = 'agenda_estudiantes_v1';
      const uid = (p='id') => `${p}_${Math.random().toString(36).slice(2,9)}`;
      const loadState = () => { try { const raw = localStorage.getItem(LS_KEY); if(!raw) return {courses:{},selectedCourseId:null}; const parsed=JSON.parse(raw); return {courses:parsed.courses||{}, selectedCourseId:parsed.selectedCourseId||null}; } catch{ return {courses:{},selectedCourseId:null}; } };
      const saveState = (s) => localStorage.setItem(LS_KEY, JSON.stringify(s));
      const pct = (st)=>{ const p=st?.present||0, a=st?.absent||0; const d=p+a; return d?Math.round((p/d)*100):0; };

      function Header(){
        return (
          <header className="w-full p-4 md:p-6 bg-slate-900 text-white flex items-center justify-between sticky top-0 z-10 shadow">
            <div className="flex flex-col md:flex-row md:items-center gap-1 md:gap-3">
              <span className="text-2xl md:text-3xl font-bold tracking-tight">Agenda de Estudiantes</span>
              {/* Subt√≠tulo clickeable (Instagram) */}
              <a
                href="https://instagram.com/docentesbrown"
                target="_blank" rel="noopener noreferrer"
                className="text-xs md:text-sm text-sky-300 underline hover:text-sky-200"
              >
                creado por @docentesbrown
              </a>
            </div>
            <a className="text-sky-300 underline text-sm hover:text-sky-200" href="#ayuda">¬øC√≥mo instalar?</a>
          </header>
        );
      }

      function EmptyState({ onCreateCourse }){
        return (
          <div className="p-6 md:p-10 text-center">
            <h2 className="text-xl md:text-2xl font-semibold mb-2">No hay cursos a√∫n</h2>
            <p className="text-slate-600 mb-4">Cre√° tu primer curso para comenzar a tomar asistencia.</p>
            <button onClick={onCreateCourse} className="px-4 py-2 rounded-xl bg-sky-600 hover:bg-sky-700 text-white shadow">+ Nuevo curso</button>
          </div>
        );
      }

      function CoursesBar({ courses, selectedCourseId, onSelect, onCreate, onRename, onDelete }){
        const [renamingId, setRenamingId] = useState(null);
        const [newName, setNewName] = useState('');
        return (
          <div className="w-full overflow-x-auto border-b border-slate-200 bg-white">
            <div className="flex items-center gap-2 p-3 min-w-max">
              {Object.values(courses).map(c => (
                <div key={c.id} className={`flex items-center gap-2 px-3 py-2 rounded-2xl border ${selectedCourseId===c.id?"border-sky-500 bg-sky-50":"border-slate-200"}`}>
                  {renamingId===c.id ? (
                    <input autoFocus value={newName} onChange={e=>setNewName(e.target.value)} onBlur={()=>{onRename(c.id, newName||c.name); setRenamingId(null);}} onKeyDown={e=>{ if(e.key==='Enter'){onRename(c.id,newName||c.name); setRenamingId(null);} if(e.key==='Escape'){setRenamingId(null);} }} className="px-2 py-1 text-sm border rounded" />
                  ) : (
                    <button className={`text-sm font-medium ${selectedCourseId===c.id?"text-sky-800":"text-slate-700"}`} onClick={()=>onSelect(c.id)}>{c.name}</button>
                  )}
                  <div className="flex items-center gap-1">
                    <button title="Renombrar" onClick={()=>{setRenamingId(c.id); setNewName(c.name);}} className="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">‚úé</button>
                    <button title="Eliminar curso" onClick={()=>onDelete(c.id)} className="text-xs px-2 py-1 rounded bg-rose-100 hover:bg-rose-200 text-rose-700">üóë</button>
                  </div>
                </div>
              ))}
              <button onClick={onCreate} className="px-3 py-2 rounded-2xl bg-slate-100 hover:bg-slate-200 text-sm">+ Nuevo curso</button>
            </div>
          </div>
        );
      }

      function StudentsTable({ students, onAdd, onEdit, onDelete }){
        const [name, setName] = useState('');
        const sorted = useMemo(()=>Object.values(students).sort((a,b)=>a.name.localeCompare(b.name)),[students]);
        return (
          <div className="p-4 md:p-6">
            <div className="flex flex-col md:flex-row gap-2 md:items-end mb-4">
              <div className="flex-1">
                <label className="block text-sm font-medium mb-1">Agregar estudiante</label>
                <input placeholder="Nombre y apellido" value={name} onChange={e=>setName(e.target.value)} className="w-full max-w-md px-3 py-2 border rounded-xl" />
              </div>
              <button onClick={()=>{ if(!name.trim()) return; onAdd(name.trim()); setName(''); }} className="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white">+ Agregar</button>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full text-left border border-slate-200 rounded-xl overflow-hidden">
                <thead className="bg-slate-50">
                  <tr>
                    <th className="p-3 text-sm">Estudiante</th>
                    <th className="p-3 text-sm">% Asistencia</th>
                    <th className="p-3 text-sm">Presente</th>
                    <th className="p-3 text-sm">Ausente</th>
                    <th className="p-3 text-sm">Revisar</th>
                    <th className="p-3 text-sm"></th>
                  </tr>
                </thead>
                <tbody>
                  {sorted.map(s => (
                    <tr key={s.id} className="border-t">
                      <td className="p-3">
                        <div className="flex items-center gap-2">
                          <span className="font-medium">{s.name}</span>
                          <button onClick={()=>{ const nuevo = prompt('Editar nombre', s.name); if(nuevo && nuevo.trim()) onEdit(s.id, nuevo.trim()); }} className="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">Editar</button>
                        </div>
                      </td>
                      <td className="p-3 font-semibold">{pct(s.stats)}%</td>
                      <td className="p-3">{s.stats?.present||0}</td>
                      <td className="p-3">{s.stats?.absent||0}</td>
                      <td className="p-3">{s.stats?.later||0}</td>
                      <td className="p-3 text-right">
                        <button onClick={()=>onDelete(s.id)} className="text-xs px-3 py-1 rounded bg-rose-100 hover:bg-rose-200 text-rose-700">Eliminar</button>
                      </td>
                    </tr>
                  ))}
                  {sorted.length===0 && (
                    <tr><td colSpan={6} className="p-4 text-center text-slate-500">Sin estudiantes. Agregue usando el campo superior.</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>
        );
      }

      function RollCallCard({ students, onMark }){
        const [index, setIndex] = useState(0);
        const [history, setHistory] = useState([]);
        const current = students[index] ?? null;
        const handleAction = (action)=>{ if(!current) return; onMark(current.id, action); setHistory(h=>[...h,{id:current.id,action}]); setIndex(i=>Math.min(i+1, students.length)); };
        const goBack = ()=>{ if(history.length===0) return; setHistory(h=>h.slice(0,-1)); setIndex(i=>Math.max(0,i-1)); };
        if(!students.length) return <div className="p-6 text-center text-slate-600">No hay estudiantes en este curso.</div>;
        return (
          <div className="p-4 md:p-6">
            <div className="max-w-xl mx-auto">
              <div className="mb-3 text-sm text-slate-500 text-center">Tarjeta {Math.min(index+1, students.length)} / {students.length}</div>
              {current ? (
                <div className="rounded-3xl border border-slate-200 shadow p-6 md:p-8 bg-white">
                  <div className="text-center mb-6">
                    <div className="text-2xl md:text-4xl font-bold tracking-tight mb-2">{current.name}</div>
                    <div className="text-sm md:text-base text-slate-600">Asistencia acumulada: <span className="font-semibold">{pct(current.stats)}%</span></div>
                  </div>
                  <div className="grid grid-cols-2 gap-3 md:gap-4">
                    <button onClick={()=>handleAction('present')} className="py-3 md:py-4 rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold shadow">Presente ‚úÖ</button>
                    <button onClick={()=>handleAction('absent')} className="py-3 md:py-4 rounded-2xl bg-rose-600 hover:bg-rose-700 text-white font-semibold shadow">Ausente ‚ùå</button>
                    <button onClick={()=>handleAction('later')} className="py-3 md:py-4 rounded-2xl bg-amber-500 hover:bg-amber-600 text-white font-semibold shadow col-span-2">Revisar m√°s tarde ‚è≥</button>
                    <button onClick={goBack} className="py-2 md:py-2.5 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-800 font-medium col-span-2">‚Üê Volver al anterior</button>
                  </div>
                </div>
              ) : (
                <div className="rounded-3xl border border-slate-200 shadow p-6 md:p-8 bg-white text-center">
                  <div className="text-xl font-semibold mb-2">¬°Lista completada!</div>
                  <div className="text-slate-600">Ya asignaste estado a todos los estudiantes. Pod√©s volver a empezar o revisar el resumen abajo.</div>
                </div>
              )}
            </div>
          </div>
        );
      }

      function App(){
        const [state, setState] = useState(loadState());
        const { courses, selectedCourseId } = state;
        useEffect(()=>{ saveState(state); }, [state]);
        const selectedCourse = selectedCourseId ? courses[selectedCourseId] : null;
        const selectCourse = (id)=> setState(s=>({...s, selectedCourseId:id}));
        const createCourse = ()=>{ const name = prompt('Nombre del curso (ej. 3¬∞B - Matem√°tica)'); if(!name||!name.trim()) return; const id=uid('curso'); setState(s=>({...s, selectedCourseId:id, courses:{...s.courses, [id]:{id, name:name.trim(), students:{}}}})); };
        const renameCourse = (id, newName)=> setState(s=>({...s, courses:{...s.courses, [id]:{...s.courses[id], name:newName}}}));
        const deleteCourse = (id)=>{ if(!confirm('¬øEliminar curso y toda su informaci√≥n?')) return; setState(s=>{ const { [id]:_omit, ...rest } = s.courses; return {...s, courses:rest, selectedCourseId: s.selectedCourseId===id?null:s.selectedCourseId }; }); };
        const addStudent = (name)=>{ const id=uid('alumno'); setState(s=>({...s, courses:{...s.courses, [selectedCourseId]:{...s.courses[selectedCourseId], students:{...s.courses[selectedCourseId].students, [id]:{id, name, stats:{present:0,absent:0,later:0}, history:[]}}}}})); };
        const editStudent = (id, newName)=> setState(s=>({...s, courses:{...s.courses, [selectedCourseId]:{...s.courses[selectedCourseId], students:{...s.courses[selectedCourseId].students, [id]:{...s.courses[selectedCourseId].students[id], name:newName}}}}}));
        const deleteStudent = (id)=> setState(s=>{ const { [id]:_omit, ...rest } = s.courses[selectedCourseId].students; return {...s, courses:{...s.courses, [selectedCourseId]:{...s.courses[selectedCourseId], students:rest}}}; });
        const markAttendance = (studentId, action)=> setState(s=>{ const course=s.courses[selectedCourseId]; const st=course.students[studentId]; const stats={...st.stats}; if(action==='present') stats.present=(stats.present||0)+1; if(action==='absent') stats.absent=(stats.absent||0)+1; if(action==='later') stats.later=(stats.later||0)+1; const history=[...st.history,{date:new Date().toISOString(), status:action}]; return {...s, courses:{...s.courses, [selectedCourseId]:{...course, students:{...course.students, [studentId]:{...st, stats, history}}}}}; });
        const studentsArr = useMemo(()=> selectedCourse? Object.values(selectedCourse.students).sort((a,b)=>a.name.localeCompare(b.name)) : [], [selectedCourse]);
        return (
          <div>
            <Header />
            {!Object.keys(courses).length ? (
              <EmptyState onCreateCourse={createCourse} />
            ) : (
              <>
                <CoursesBar courses={courses} selectedCourseId={selectedCourseId} onSelect={selectCourse} onCreate={createCourse} onRename={renameCourse} onDelete={deleteCourse} />
                {!selectedCourse ? (
                  <div className="p-6 text-slate-600">Seleccion√° un curso para administrar estudiantes y tomar lista.</div>
                ) : (
                  <>
                    <div className="p-4 md:p-6">
                      <h2 className="text-xl md:text-2xl font-semibold">{selectedCourse.name}</h2>
                      <p className="text-slate-600">Estudiantes: {studentsArr.length}</p>
                    </div>
                    <RollCallCard students={studentsArr} onMark={markAttendance} />
                    <StudentsTable students={selectedCourse.students} onAdd={addStudent} onEdit={editStudent} onDelete={deleteStudent} />
                  </>
                )}
              </>
            )}

            <footer id="ayuda" className="p-6 md:p-8 text-sm text-slate-600">
              <div className="max-w-3xl mx-auto space-y-3">
                <h3 className="text-base md:text-lg font-semibold text-slate-800">¬øC√≥mo instalar en el celular?</h3>
                <ol className="list-decimal ml-5 space-y-1">
                  <!-- Se quit√≥ el punto 1, quedan solo Android/iOS -->
                  <li>En Android/Chrome: Men√∫ ‚ãÆ ‚Üí <em>A√±adir a la pantalla de inicio</em>.</li>
                  <li>En iOS/Safari: Compartir ‚Üí <em>A√±adir a pantalla de inicio</em>.</li>
                </ol>
                <p className="text-xs opacity-80">Los datos quedan guardados offline en tu dispositivo (localStorage + Service Worker).</p>
              </div>
            </footer>

            <!-- Bot√≥n de donaci√≥n al final -->
            <div className="p-6 md:p-8 text-center">
              <a
                href="https://cafecito.app/docentesbrown"
                target="_blank" rel="noopener noreferrer"
                className="inline-block px-5 py-3 rounded-xl bg-amber-500 hover:bg-amber-600 text-white font-semibold shadow"
              >
                ‚òï Invitanos un cafecito
              </a>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
