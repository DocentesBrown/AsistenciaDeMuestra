<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agenda de Estudiantes</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body class="bg-gray-100">
  <header class="bg-blue-600 text-white p-4 shadow-md text-center">
    <h1 class="text-2xl font-bold">Agenda de Estudiantes</h1>
    <p class="text-sm">
      <a href="https://instagram.com/docentesbrown" target="_blank" class="underline">
        creado por @docentesbrown
      </a>
    </p>
  </header>

  <main id="root" class="p-4"></main>

  <footer class="text-center mt-6 mb-6">
    <a href="https://cafecito.app/docentesbrown" target="_blank" 
       class="bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-2 px-4 rounded">
       ☕ Invitame un cafecito
    </a>
  </footer>

  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect } = React;

    const initialCourses = JSON.parse(localStorage.getItem("courses") || "[]");

    function App() {
      const [courses, setCourses] = useState(initialCourses);
      const [currentCourse, setCurrentCourse] = useState(null);
      const [queue, setQueue] = useState([]);
      const [history, setHistory] = useState([]);
      const [today, setToday] = useState(new Date().toISOString().substr(0,10));

      useEffect(() => {
        localStorage.setItem("courses", JSON.stringify(courses));
      }, [courses]);

      function addCourse(name) {
        setCourses([...courses, { id: Date.now(), name, students: [] }]);
      }

      function addStudent(courseId, studentName) {
        setCourses(courses.map(c =>
          c.id === courseId
            ? { ...c, students: [...c.students, { 
                id: Date.now(), 
                name: studentName, 
                present: 0, 
                absent: 0, 
                later: 0, 
                history: [] 
              }] }
            : c
        ));
      }

      function markAttendance(student, status) {
        setCourses(courses.map(c => {
          if (c.id !== currentCourse.id) return c;
          return {
            ...c,
            students: c.students.map(s => {
              if (s.id !== student.id) return s;
              const updated = { ...s };
              if (status === "present") updated.present++;
              if (status === "absent") updated.absent++;
              if (status === "later") updated.later++;
              updated.history.push({ date: today, status });
              return updated;
            })
          };
        }));
        if (status === "later") {
          setQueue([...queue.slice(1), student]);
        } else {
          setQueue(queue.slice(1));
        }
        setHistory([...history, { student, status }]);
      }

      function undo() {
        const last = history[history.length - 1];
        if (!last) return;
        const { student, status } = last;
        setCourses(courses.map(c => {
          if (c.id !== currentCourse.id) return c;
          return {
            ...c,
            students: c.students.map(s => {
              if (s.id !== student.id) return s;
              const updated = { ...s };
              if (status === "present") updated.present--;
              if (status === "absent") updated.absent--;
              if (status === "later") updated.later--;
              updated.history.pop();
              return updated;
            })
          };
        }));
        setQueue([student, ...queue]);
        setHistory(history.slice(0, -1));
      }

      if (!currentCourse) {
        return (
          <div>
            <h2 className="text-xl mb-2">Cursos</h2>
            <ul className="mb-4">
              {courses.map(c => (
                <li key={c.id} className="mb-2">
                  <button 
                    className="bg-green-500 text-white px-3 py-1 rounded"
                    onClick={() => {
                      setCurrentCourse(c);
                      setQueue(c.students);
                    }}>
                    {c.name}
                  </button>
                </li>
              ))}
            </ul>
            <AddCourseForm onAdd={addCourse} />
          </div>
        );
      }

      const currentStudent = queue[0];

      return (
        <div>
          <h2 className="text-xl mb-2">{currentCourse.name}</h2>
          <input 
            type="date" 
            value={today} 
            onChange={e => setToday(e.target.value)} 
            className="border p-1 mb-4"
          />
          <button 
            className="bg-gray-400 text-white px-2 py-1 rounded mb-4"
            onClick={() => setCurrentCourse(null)}>
            Volver a Cursos
          </button>

          <AddStudentForm onAdd={name => addStudent(currentCourse.id, name)} />

          {currentStudent ? (
            <div className="bg-white p-6 rounded shadow-md text-center">
              <h3 className="text-2xl font-bold mb-2">{currentStudent.name}</h3>
              <p className="mb-4">
                Asistencia: {currentStudent.present + currentStudent.absent > 0
                  ? Math.round((currentStudent.present / (currentStudent.present + currentStudent.absent)) * 100)
                  : 0}%
              </p>
              <div className="flex justify-around">
                <button onClick={() => markAttendance(currentStudent, "present")}
                  className="bg-green-500 text-white px-3 py-2 rounded">Presente</button>
                <button onClick={() => markAttendance(currentStudent, "absent")}
                  className="bg-red-500 text-white px-3 py-2 rounded">Ausente</button>
                <button onClick={() => markAttendance(currentStudent, "later")}
                  className="bg-yellow-500 text-white px-3 py-2 rounded">Revisar más tarde</button>
                <button onClick={undo}
                  className="bg-gray-500 text-white px-3 py-2 rounded">← Deshacer</button>
              </div>
            </div>
          ) : (
            <p className="mt-4">Lista finalizada.</p>
          )}
        </div>
      );
    }

    function AddCourseForm({ onAdd }) {
      const [name, setName] = useState("");
      return (
        <form onSubmit={e => { e.preventDefault(); onAdd(name); setName(""); }} className="mb-4">
          <input value={name} onChange={e => setName(e.target.value)} placeholder="Nombre del curso" className="border p-1 mr-2"/>
          <button className="bg-blue-500 text-white px-2 py-1 rounded">Agregar Curso</button>
        </form>
      );
    }

    function AddStudentForm({ onAdd }) {
      const [name, setName] = useState("");
      return (
        <form onSubmit={e => { e.preventDefault(); onAdd(name); setName(""); }} className="mb-4">
          <input value={name} onChange={e => setName(e.target.value)} placeholder="Nombre del estudiante" className="border p-1 mr-2"/>
          <button className="bg-blue-500 text-white px-2 py-1 rounded">Agregar Estudiante</button>
        </form>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js");
    }
  </script>
</body>
</html>
